name: Tailscale Runner with State Persistence

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  runner:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # === RESTORE STATE ===
      - name: Restore Tailscale state from Google Drive
        shell: pwsh
        run: |
          Write-Host "=== Restoring Tailscale state from Google Drive ==="

          # === Setup Paths ===
          $credPath = "$env:TEMP\service-account.json"
          $confPath = "$env:TEMP\rclone.conf"
          $localDir = "C:\ProgramData\Tailscale"
          $stateFile = "server-state.conf"
          $driveFolderId = "1pa6J-zMHmhkFExunAcXWitHW1SU976Wo"

          # === Write service account credential from secret ===
          $json = '${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}'
          $json | Out-File -FilePath $credPath -Encoding utf8

          # === Prepare local dir ===
          New-Item -ItemType Directory -Path $localDir -Force | Out-Null

          # === Install rclone ===
          Write-Host "Downloading and installing rclone..."
          Invoke-WebRequest -Uri "https://downloads.rclone.org/rclone-current-windows-amd64.zip" -OutFile "rclone.zip"
          Expand-Archive rclone.zip -DestinationPath . -Force
          Move-Item .\rclone-*\rclone.exe . -Force
          $env:PATH += ";$pwd"

          # === Create rclone config ===
          $confContent = @"
          [drive]
          type = drive
          scope = drive
          service_account_file = $credPath
          "@
          $confContent | Out-File -FilePath $confPath -Encoding utf8

          # === Try to restore from Drive ===
          Write-Host "Attempting to restore state from Google Drive folder ID: $driveFolderId"
          try {
              & .\rclone.exe copy drive:$stateFile $localDir --config=$confPath --drive-root-folder-id=$driveFolderId --no-traverse --ignore-errors
              if ($LASTEXITCODE -ne 0) {
                  Write-Host "⚠️ rclone exited with code $LASTEXITCODE — probably first run. Continuing..."
                  $LASTEXITCODE = 0
              }
          } catch {
              Write-Host "⚠️ Exception caught while restoring (likely first run). Continuing..."
          }

          if (Test-Path "$localDir\$stateFile") {
              Write-Host "✅ Restored previous Tailscale state: $localDir\$stateFile"
          } else {
              Write-Host "⚠️ No previous state found — starting fresh (this is normal on first run)."
          }

      # === START TAILSCALE ===
      - name: Start Tailscale
        shell: pwsh
        run: |
          Write-Host "=== Starting Tailscale ==="
          tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname=github-runner
          Write-Host "Tailscale started successfully."

      # === MAIN TASK ===
      - name: Do your main work
        run: |
          echo "Running main tasks..."
          # Tambahkan perintah build/test/deploy kamu di sini
          # Misalnya:
          # npm ci && npm run build

      # === SAVE STATE ===
      - name: Save updated Tailscale state back to Google Drive
        if: always()
        shell: pwsh
        run: |
          Write-Host "=== Uploading updated Tailscale state to Google Drive ==="

          $credPath = "$env:TEMP\service-account.json"
          $confPath = "$env:TEMP\rclone.conf"
          $localDir = "C:\ProgramData\Tailscale"
          $stateFile = "server-state.conf"
          $driveFolderId = "1pa6J-zMHmhkFExunAcXWitHW1SU976Wo"

          # === Write creds again ===
          $json = '${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}'
          $json | Out-File -FilePath $credPath -Encoding utf8

          # === Create rclone config ===
          $confContent = @"
          [drive]
          type = drive
          scope = drive
          service_account_file = $credPath
          "@
          $confContent | Out-File -FilePath $confPath -Encoding utf8

          # === Upload state file ===
          if (Test-Path "$localDir\$stateFile") {
              Write-Host "Uploading $stateFile to Google Drive folder ID: $driveFolderId ..."
              try {
                  & .\rclone.exe copy "$localDir\$stateFile" drive: --config=$confPath --drive-root-folder-id=$driveFolderId --ignore-errors --no-traverse
                  if ($LASTEXITCODE -eq 0) {
                      Write-Host "✅ State uploaded successfully."
                  } else {
                      Write-Host "⚠️ Upload exited with code $LASTEXITCODE (ignored)."
                      $LASTEXITCODE = 0
                  }
              } catch {
                  Write-Host "⚠️ Exception while uploading state — continuing anyway."
              }
          } else {
              Write-Host "⚠️ No local state file found to upload."
          }
